<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”¢å“åˆ†ç´šæŠ˜æ‰£èˆ‡é»æ•¸è¨ˆç®—å·¥å…· (HKD - æœƒå“¡åƒ¹)</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f7f6;
            padding: 20px;
            color: #333;
        }
        .container {
            max-width: 1300px;
            margin: 0 auto;
            background-color: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #007bff;
            text-align: center;
            margin-bottom: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
            font-size: 13px;
        }
        th {
            background-color: #e9ecef;
            color: #333;
            font-weight: 600;
        }
        .sku-input, .qty-input {
            width: 90%;
            padding: 6px;
            border: 1px solid #ccc;
            border-radius: 3px;
            box-sizing: border-box;
        }
        .read-only {
            background-color: #f8f9fa;
            color: #555;
            font-weight: bold;
        }
        .add-btn, .quick-input-btn, .print-btn {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin-bottom: 20px;
            float: right;
            margin-left: 10px;
        }
        .quick-input-btn {
            background-color: #ffc107;
            color: #333;
        }
        .print-btn {
            background-color: #007bff;
            float: left;
        }
        /* ç¸½çµå€å¡Šæ¨£å¼ */
        .summary-box {
            background-color: #fff;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 6px;
        }
        .summary-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px dashed #eee;
            font-size: 16px;
        }
        .total-due {
            margin-top: 15px;
            background-color: #dc3545; /* æœ€çµ‚ç¸½åƒ¹ä½¿ç”¨ç´…è‰²å¼·èª¿ */
            color: white;
            padding: 12px;
            border-radius: 4px;
            font-size: 20px;
            text-align: center;
        }
        #searchResults {
            padding: 10px;
            border: 1px dashed #ccc;
            background-color: #ffffff;
            border-radius: 4px;
        }
        .client-type-btn {
            padding: 8px 15px;
            border: 1px solid #ccc;
            background-color: #eee;
            cursor: pointer;
            border-radius: 4px;
            margin-right: 10px;
        }
        .client-type-btn.active {
            background-color: #007bff;
            color: white;
            border-color: #0056b3;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>ç”¢å“åˆ†ç´šæŠ˜æ‰£èˆ‡é»æ•¸è¨ˆç®—å·¥å…· (HKD æ¸¯å¹£)</h1>

        <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 6px;">
            <div style="margin-bottom: 15px;">
                <label style="font-weight: bold; margin-right: 15px;">ğŸ‘¤ è«‹é¸æ“‡å®¢æˆ¶èº«ä»½:</label>
                <button class="client-type-btn active" id="btn-distributor" onclick="setClientType('distributor')">ç›´éŠ·å•† (Distributor)</button>
                <button class="client-type-btn" id="btn-pc" onclick="setClientType('pc')">å„ªæƒ å®¢æˆ¶ (Preferred Customer)</button>
            </div>

            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <label for="discountLevel" style="font-weight: bold; margin-right: 15px;">ğŸ”– è«‹é¸æ“‡æœ¬æ¬¡è¨‚å–®çš„æŠ˜æ‰£ç´šåˆ¥:</label>
                    <select id="discountLevel" onchange="calculateTotals()" style="padding: 8px; border-radius: 4px;">
                        <option value="0.15" selected>15% æŠ˜æ‰£</option> 
                        <option value="0.25">25% æŠ˜æ‰£</option>
                        <option value="0.35">35% æŠ˜æ‰£</option>
                        <option value="0.42">42% æŠ˜æ‰£</option>
                        <option value="0.50">50% æŠ˜æ‰£</option>
                    </select>
                </div>
                <div id="shipping-rule-display" style="font-weight: bold; color: #dc3545;">
                    é‹è²»è¦å‰‡: è¨‚å–®é›¶å”®ç¸½åƒ¹ HK$ 4,000.00 ä»¥ä¸‹ï¼Œé‹è²» HK$ 30.00
                </div>
            </div>
        </div>
        
        <div style="margin-bottom: 20px; padding: 15px; background: #e6f7ff; border-radius: 6px;">
            <label for="productNameSearch" style="font-weight: bold; margin-right: 15px;">ğŸ” ç”¢å“åç¨±æœå°‹:</label>
            <input type="text" id="productNameSearch" placeholder="è¼¸å…¥ç”¢å“åç¨±é—œéµå­— (è‡³å°‘ 2 å€‹å­—)" style="padding: 6px; width: 300px;">
            <button class="add-btn" style="float: none; margin-left: 10px; background-color: #007bff;" onclick="performSearch()">æœå°‹</button>
            <div id="searchResults" style="margin-top: 10px; display: none;">
                </div>
        </div>

        <div style="margin-bottom: 20px;">
            <button class="print-btn" onclick="generatePrintOrder()">ğŸ–¨ï¸ ç”Ÿæˆåˆ—å°ç”¨è¨‚å–®è¡¨</button>
            <button class="add-btn" onclick="addRow()">+ æ–°å¢ç”¢å“</button>
            <button class="quick-input-btn" onclick="quickFill()">4æ¯æ°´</button>
            <div style="clear: both;"></div>
        </div>
        
        <table id="productTable">
            <thead>
                <tr>
                    <th rowspan="2">æ“ä½œ</th>
                    <th rowspan="2">ç”¢å“ç·¨è™Ÿ (SKU)</th>
                    <th rowspan="2">æ•¸é‡ (Qty)</th>
                    <th rowspan="2">ç”¢å“åç¨±</th>
                    <th colspan="2">ç©é»/åŸºæ•¸</th>
                    <th colspan="2">åƒ¹æ ¼ (HK$)</th>
                </tr>
                <tr>
                    <th>éŠ·å”®é‡é»æ•¸ (VP)</th>
                    <th>æ”¶å…¥åŸºæ•¸ (Earn Base)</th>
                    <th>è¼”éŠ·å“åƒ¹æ ¼ (Literature Price)</th>
                    <th>é›¶å”®åƒ¹æ ¼ (Retail)</th>
                </tr>
            </thead>
            <tbody>
                </tbody>
        </table>

        <div style="clear: both;"></div>

        <h2>è¨‚å–®ç¸½çµèˆ‡è¨ˆç®—çµæœ</h2>
        <div class="summary-box">
            <div class="summary-item">
                <span class="label">ç¸½éŠ·å”®é‡é»æ•¸ (VP)</span>
                <span id="sum-vp" class="value" style="color: #009688;">0.00</span>
            </div>
            <div class="summary-item">
                <span class="label">ç¸½æ”¶å…¥åŸºæ•¸ (Earn Base)</span>
                <span id="sum-earnBase" class="value">0.00</span>
            </div>
            <div class="summary-item">
                <span class="label">ç¸½é›¶å”®åƒ¹æ ¼ (æœªæŠ˜)</span>
                <span id="sum-totalRetail" class="value" style="font-weight: bold;">HK$ 0.00</span>
            </div>
            <div class="summary-item" style="font-size: 18px; background: #ffebee;">
                <span class="label">ç¸½æŠ˜æ‰£é‡‘é¡ (<span id="discount-display">25%</span>, åŸºæ–¼ç¸½æ”¶å…¥åŸºæ•¸è¨ˆç®—)</span>
                <span id="sum-discountAmount" class="value" style="color: #dc3545;">- HK$ 0.00</span>
            </div>
            <div class="summary-item" style="border-top: 2px solid #ddd;">
                <span class="label">è‡ªå‹•è¨ˆç®—é‹è²» (<span id="client-type-text">ç›´éŠ·å•†</span>)</span>
                <span id="sum-shipping" class="value" style="font-weight: bold;">HK$ 0.00</span>
            </div>
            <div class="summary-item total-due">
                <span class="label">å®¢æˆ¶æ‡‰æ”¶ç¸½é‡‘é¡ (å«é‹è²»)</span>
                <span id="sum-totalDue" class="value">HK$ 0.00</span>
            </div>
        </div>
    </div>

    <script>
        // ç”¢å“æ•¸æ“šåº« (èˆ‡æ‚¨æä¾›çš„æ•¸æ“šä¸€è‡´ï¼Œæ­¤è™•çœç•¥é•·åˆ—è¡¨ä»¥ç¯€çœç©ºé–“)
        const productDatabase = {
            '0006': { name: 'æ¿ƒç¸®è˜†è–ˆæ± Herbal Aloe Concentrate', vp: 24.95, earnBase: 401.00, literature: 0.00, retail: 439.00 },
            '0022': { name: 'äº”å‘³å­ç²¾è¯ Schizandra Plus', vp: 15.50, earnBase: 297.00, literature: 0.00, retail: 325.00 },
            '0036': { name: 'å¤œå¯§æ–°ç‡Ÿé¤Šé£²å“ NiteworksÂ®', vp: 89.95, earnBase: 1490.00, literature: 0.00, retail: 1630.00 },
            '0056': { name: 'è† åŸè›‹ç™½ç¾è‚Œé£²æ–™ Beauty Powder Drink', vp: 43.55, earnBase: 865.00, literature: 0.00, retail: 946.00 },
            '0102': { name: 'å¤©ç„¶ç“œæ‹‰æ‹¿èŒ¶ N-R-GÂ® Tea', vp: 14.75, earnBase: 291.00, literature: 0.00, retail: 318.00 },
            '0141': { name: 'ç‡Ÿé¤Šè›‹ç™½ç´  - é›²å‘¢æ‹¿ Nutritional Protein Drink Mix - Vanilla', vp: 23.95, earnBase: 418.00, literature: 0.00, retail: 457.00 },
            '0242': { name: 'ä½³èƒ½è›‹ç™½è³ªç²‰ Performance Protein Powder', vp: 17.95, earnBase: 333.00, literature: 0.00, retail: 364.00 },
            '0909': { name: 'æœƒç±æœå‹™å¹´è²» - é ˜ç­ Annual Membership Services Fee - Supervisor', vp: 0.00, earnBase: 0.00, literature: 613.00, retail: 613.00 },
            '9943': { name: 'Bizworks é¦–æ¬¡ç™»è¨˜å…2å€‹æœˆæœˆè²»å„ªæƒ  Bizworks 2-month Promotion for first time reg', vp: 0.00, earnBase: 0.00, literature: 0.00, retail: 0.00 },
            // ... (è«‹å°‡å®Œæ•´çš„ç”¢å“åˆ—è¡¨æ•¸æ“šè²¼å›æ­¤è™•)
        };
        // ==========================================================

        const FIXED_SHIPPING_FEE = 30.00; // æ¸¯å¹£å›ºå®šé‹è²»
        const QUICK_FILL_SKUS = ['0141', '0006', '0102', '0242']; 
        
        // é‹è²»è¦å‰‡é–¾å€¼
        const SHIPPING_THRESHOLDS = {
            'distributor': 4000.00, // ç›´éŠ·å•†æ»¿ $4000 å…é‹
            'pc': 2500.00           // å„ªæƒ å®¢æˆ¶æ»¿ $2500 å…é‹
        };

        let currentClientType = 'distributor'; // é è¨­ç‚ºç›´éŠ·å•†

        // --- åˆå§‹åŒ– ---
        document.addEventListener('DOMContentLoaded', () => {
            addRow(); 
            calculateTotals();
            setClientType('distributor'); // åˆå§‹åŒ–é¡¯ç¤ºç›´éŠ·å•†è¦å‰‡
        });

        // --- è¨­ç½®å®¢æˆ¶èº«ä»½ ---
        function setClientType(type) {
            currentClientType = type;
            const btnDistributor = document.getElementById('btn-distributor');
            const btnPC = document.getElementById('btn-pc');
            const ruleDisplay = document.getElementById('shipping-rule-display');
            const clientTypeText = document.getElementById('client-type-text');
            
            if (type === 'distributor') {
                btnDistributor.classList.add('active');
                btnPC.classList.remove('active');
                ruleDisplay.innerHTML = `é‹è²»è¦å‰‡: ç›´éŠ·å•†è¨‚å–®**é›¶å”®ç¸½åƒ¹ HK$ ${SHIPPING_THRESHOLDS.distributor.toFixed(2)} ä»¥ä¸‹**ï¼Œé‹è²» HK$ ${FIXED_SHIPPING_FEE.toFixed(2)}`;
                clientTypeText.textContent = 'ç›´éŠ·å•†';
            } else {
                btnPC.classList.add('active');
                btnDistributor.classList.remove('active');
                ruleDisplay.innerHTML = `é‹è²»è¦å‰‡: å„ªæƒ å®¢æˆ¶è¨‚å–®**é›¶å”®ç¸½åƒ¹ HK$ ${SHIPPING_THRESHOLDS.pc.toFixed(2)} ä»¥ä¸‹**ï¼Œé‹è²» HK$ ${FIXED_SHIPPING_FEE.toFixed(2)}`;
                clientTypeText.textContent = 'å„ªæƒ å®¢æˆ¶';
            }

            calculateTotals();
        }

        // --- æ ¸å¿ƒæŸ¥æ‰¾å‡½æ•¸ (SKU Lookup) ---
        function lookupProduct(inputElement) {
            const sku = inputElement.value.toUpperCase().trim();
            const row = inputElement.closest('tr');
            const product = productDatabase[sku];

            const productName = row.cells[3].querySelector('input');
            const vp = row.cells[4].querySelector('[data-field="vp"]');
            const earnBase = row.cells[5].querySelector('[data-field="earnBase"]');
            const literaturePrice = row.cells[6].querySelector('[data-field="literaturePrice"]');
            const retailPrice = row.cells[7].querySelector('[data-field="retailPrice"]');

            if (product) {
                // æ‰¾åˆ°ç”¢å“ï¼Œè‡ªå‹•å¡«å……è³‡æ–™
                productName.value = product.name;
                vp.value = product.vp;
                earnBase.value = product.earnBase;
                literaturePrice.value = product.literature;
                retailPrice.value = product.retail;
            } else {
                // æœªæ‰¾åˆ°ç”¢å“ï¼Œæ¸…ç©ºæ¬„ä½
                productName.value = 'æœªæ‰¾åˆ°';
                vp.value = 0;
                earnBase.value = 0;
                literaturePrice.value = 0;
                retailPrice.value = 0;
            }
            calculateTotals(); 
        }

        // --- ç”¢å“åç¨±æœå°‹ã€æ–°å¢è¡Œã€ç§»é™¤è¡Œç­‰åŠŸèƒ½èˆ‡å‰ä¸€ç‰ˆä¿æŒä¸€è‡´ ---
        // (çœç•¥ search, addRow, quickFill, removeRow å‡½æ•¸ç¨‹å¼ç¢¼ä»¥ä¿æŒç°¡æ½”)
        // ...
        function addRow(sku = '', qty = 1) {
            const tableBody = document.querySelector('#productTable tbody');
            const newRow = tableBody.insertRow();
            newRow.innerHTML = `
                <td><button class="remove-btn" onclick="removeRow(this)">ç§»é™¤</button></td>
                <td><input type="text" class="sku-input" onchange="lookupProduct(this)" placeholder="è¼¸å…¥SKU" value="${sku}" ></td>
                <td><input type="number" class="qty-input" min="1" value="${qty}" oninput="calculateTotals()"></td>
                <td><input type="text" class="read-only" readonly value="---"></td>
                <td><input type="number" class="read-only" readonly value="0" data-field="vp"></td>
                <td><input type="number" class="read-only" readonly value="0" data-field="earnBase"></td>
                <td><input type="number" class="read-only" readonly value="0" data-field="literaturePrice"></td>
                <td><input type="number" class="read-only" readonly value="0" data-field="retailPrice"></td>
            `;
            if (sku) {
                lookupProduct(newRow.cells[1].querySelector('.sku-input'));
            } else {
                calculateTotals();
            }
        }
        function removeRow(buttonElement) {
            const row = buttonElement.closest('tr');
            row.remove();
            calculateTotals();
        }
        function quickFill() {
            const tableBody = document.querySelector('#productTable tbody');
            tableBody.innerHTML = '';
            QUICK_FILL_SKUS.forEach(sku => { addRow(sku.toUpperCase(), 1); });
            calculateTotals();
        }
        function performSearch() {
            const searchTerm = document.getElementById('productNameSearch').value.toUpperCase().trim();
            const resultsDiv = document.getElementById('searchResults');
            resultsDiv.innerHTML = '';
            
            if (searchTerm.length < 2) {
                resultsDiv.innerHTML = '<p style="color: red; margin: 0;">è«‹è¼¸å…¥è‡³å°‘ 2 å€‹é—œéµå­—é€²è¡Œæœå°‹ã€‚</p>';
                resultsDiv.style.display = 'block';
                return;
            }

            let found = false;
            for (const sku in productDatabase) {
                const product = productDatabase[sku];
                if (product.name.toUpperCase().includes(searchTerm)) {
                    found = true;
                    const resultItem = document.createElement('div');
                    resultItem.innerHTML = `
                        <span style="font-weight: bold;">[${sku}]</span> ${product.name} 
                        <span style="color: #007bff;">(é›¶å”®åƒ¹: HK$ ${product.retail.toFixed(2)})</span>
                        <button onclick="addProductFromSearch('${sku}')" style="margin-left: 15px; background: #28a745; color: white; border: none; padding: 4px 8px; cursor: pointer; border-radius: 3px;">åŠ å…¥</button>
                    `;
                    resultItem.style.padding = '5px 0';
                    resultItem.style.borderBottom = '1px dotted #eee';
                    resultsDiv.appendChild(resultItem);
                }
            }

            if (!found) {
                resultsDiv.innerHTML = '<p style="color: #6c757d; margin: 0;">æœªæ‰¾åˆ°ç¬¦åˆæ¢ä»¶çš„ç”¢å“ã€‚è«‹å˜—è©¦ä¸åŒçš„é—œéµå­—ã€‚</p>';
            }

            resultsDiv.style.display = 'block';
        }
        function addProductFromSearch(sku) {
            addRow(sku, 1);
            document.getElementById('searchResults').style.display = 'none';
            document.getElementById('productNameSearch').value = ''; 
        }

        // --- æ ¸å¿ƒç¸½è¨ˆç®—å‡½æ•¸ (å«è‡ªå‹•é‹è²»é‚è¼¯) ---
        function calculateTotals() {
            const rows = document.querySelectorAll('#productTable tbody tr');
            let totalVP = 0;
            let totalEarnBase = 0;
            let overallTotalRetail = 0; // æ ¸å¿ƒï¼šç”¨æ–¼è¨ˆç®—æŠ˜æ‰£å’Œé‹è²»åˆ¤å®š

            const discountLevelElement = document.getElementById('discountLevel');
            const discountFactor = parseFloat(discountLevelElement.value); 
            const discountPercentage = (discountFactor * 100).toFixed(0) + '%'; 

            rows.forEach(row => {
                const qty = parseInt(row.cells[2].querySelector('.qty-input').value) || 0;
                const vp = parseFloat(row.cells[4].querySelector('[data-field="vp"]').value) || 0;
                const earnBase = parseFloat(row.cells[5].querySelector('[data-field="earnBase"]').value) || 0;
                const retailPrice = parseFloat(row.cells[7].querySelector('[data-field="retailPrice"]').value) || 0;

                totalVP += vp * qty;
                totalEarnBase += earnBase * qty;
                overallTotalRetail += retailPrice * qty;
            });
            
            // 1. è¨ˆç®—ç¸½æŠ˜æ‰£é‡‘é¡: ç¸½æ”¶å…¥åŸºæ•¸ x æŠ˜æ‰£ç‡
            const totalDiscountAmount = totalEarnBase * discountFactor;

            // 2. æœ€çµ‚å®¢æˆ¶æ‡‰ä»˜ç”¢å“ç¸½åƒ¹ (æœƒå“¡åƒ¹)
            const finalProductTotal = overallTotalRetail - totalDiscountAmount;

            // 3. é‹è²»è‡ªå‹•åˆ¤å®š
            let appliedShippingFee = FIXED_SHIPPING_FEE;
            const threshold = SHIPPING_THRESHOLDS[currentClientType];

            if (overallTotalRetail > threshold) {
                appliedShippingFee = 0.00; // å…é‹è²»
            } else if (overallTotalRetail === 0) {
                 appliedShippingFee = 0.00; // é›¶è¨‚å–®ä¹Ÿå…é‹ (é¿å…ç©ºè¨‚å–®é¡¯ç¤ºé‹è²»)
            } else {
                appliedShippingFee = FIXED_SHIPPING_FEE; // æ”¶å–é‹è²»
            }

            // 4. æ‡‰æ”¶ç¸½é‡‘é¡ (ç”¢å“ç¸½åƒ¹ + é‹è²»)
            const totalAmountDue = finalProductTotal + appliedShippingFee;

            // --- æ›´æ–°ç¸½çµå€å¡Š ---
            document.getElementById('sum-vp').textContent = totalVP.toFixed(2);
            document.getElementById('sum-earnBase').textContent = totalEarnBase.toFixed(2);
            document.getElementById('sum-totalRetail').textContent = `HK$ ${overallTotalRetail.toFixed(2)}`;
            document.getElementById('sum-discountAmount').textContent = `- HK$ ${totalDiscountAmount.toFixed(2)}`;
            document.getElementById('discount-display').textContent = discountPercentage;
            document.getElementById('sum-shipping').textContent = `HK$ ${appliedShippingFee.toFixed(2)} (${overallTotalRetail > threshold ? 'å…é‹' : 'æ”¶å–'})`;
            document.getElementById('sum-totalDue').textContent = `HK$ ${totalAmountDue.toFixed(2)}`;
        }


        // --- ç”Ÿæˆåˆ—å°ç”¨è¨‚å–®è¡¨åŠŸèƒ½ (å·²æ–°å¢) ---
        function generatePrintOrder() {
            const tableBody = document.querySelector('#productTable tbody');
            const rows = tableBody.querySelectorAll('tr');
            let orderItemsHtml = '';
            let totalVP = 0;
            let totalEarnBase = 0;
            let overallTotalRetail = 0;
            let totalDiscountAmount = 0;
            let finalProductTotal = 0;
            let appliedShippingFee = 0;
            let totalAmountDue = 0;
            const discountFactor = parseFloat(document.getElementById('discountLevel').value);
            const discountPercentage = (discountFactor * 100).toFixed(0) + '%';

            // é‡æ–°é‹è¡Œè¨ˆç®—é‚è¼¯ä»¥ç¢ºä¿æ•¸æ“šæœ€æ–°
            calculateTotals(); 

            // å¾ DOM å–å¾—æœ€çµ‚è¨ˆç®—çµæœ (ç¢ºä¿èˆ‡ä¸»é é¢ä¸€è‡´)
            totalVP = parseFloat(document.getElementById('sum-vp').textContent);
            totalEarnBase = parseFloat(document.getElementById('sum-earnBase').textContent);
            overallTotalRetail = parseFloat(document.getElementById('sum-totalRetail').textContent.replace('HK$', '').trim());
            totalDiscountAmount = parseFloat(document.getElementById('sum-discountAmount').textContent.replace('- HK$', '').trim());
            
            // ç”±æ–¼é‹è²»é¡¯ç¤ºå¸¶æœ‰æ–‡å­—ï¼Œæˆ‘å€‘éœ€è¦å¾è¨ˆç®—çµæœä¸­æå–ç´”æ•¸å­—
            const shippingText = document.getElementById('sum-shipping').textContent;
            appliedShippingFee = parseFloat(shippingText.split('(')[0].replace('HK$', '').trim());
            
            totalAmountDue = parseFloat(document.getElementById('sum-totalDue').textContent.replace('HK$', '').trim());
            finalProductTotal = totalAmountDue - appliedShippingFee;
            
            // å»ºç«‹è¨‚å–®æ˜ç´° HTML
            rows.forEach(row => {
                const sku = row.cells[1].querySelector('.sku-input').value.toUpperCase().trim();
                const qty = parseInt(row.cells[2].querySelector('.qty-input').value) || 0;
                const productName = row.cells[3].querySelector('input').value;
                const retailPrice = parseFloat(row.cells[7].querySelector('[data-field="retailPrice"]').value) || 0;
                const vp = parseFloat(row.cells[4].querySelector('[data-field="vp"]').value) || 0;
                
                if (sku && qty > 0 && productName !== 'æœªæ‰¾åˆ°') {
                    const lineRetailTotal = retailPrice * qty;
                    const lineVP = vp * qty;

                    // ç¢ºä¿ç”¢å“åç¨±è¼ƒé•·æ™‚èƒ½æ›è¡Œ
                    orderItemsHtml += `
                        <tr>
                            <td>${sku}</td>
                            <td style="text-align: left;">${productName}</td>
                            <td>${qty}</td>
                            <td>${lineVP.toFixed(2)}</td>
                            <td>${retailPrice.toFixed(2)}</td>
                            <td>${lineRetailTotal.toFixed(2)}</td>
                        </tr>
                    `;
                }
            });

            if (!orderItemsHtml) {
                alert('è¨‚å–®ä¸­æ²’æœ‰æœ‰æ•ˆç”¢å“ï¼Œç„¡æ³•ç”Ÿæˆè¨‚å–®è¡¨ã€‚');
                return;
            }

            // è¨‚å–®è¡¨ HTML æ¨¡æ¿
            const printWindowContent = `
                <html>
                <head>
                    <title>è¨‚å–®æ‘˜è¦ - ${document.getElementById('client-type-text').textContent} (${discountPercentage})</title>
                    <style>
                        body { font-family: 'Arial', sans-serif; margin: 30px; }
                        h2 { color: #007bff; border-bottom: 2px solid #007bff; padding-bottom: 5px; margin-bottom: 20px; }
                        table { width: 100%; border-collapse: collapse; margin-bottom: 30px; }
                        th, td { border: 1px solid #000; padding: 8px; text-align: center; font-size: 12px; }
                        th { background-color: #f2f2f2; }
                        .summary-table td { border: none; padding: 5px 0; }
                        .final-total { background-color: #dc3545; color: white; font-weight: bold; font-size: 16px; }
                        .info-box { border: 1px solid #ccc; padding: 15px; margin-bottom: 20px; background-color: #f9f9f9; }
                    </style>
                </head>
                <body>
                    <h2>è¨‚å–®æ‘˜è¦ (${document.getElementById('client-type-text').textContent} - ${discountPercentage} æŠ˜æ‰£)</h2>

                    <div class="info-box">
                        **æœƒå“¡åƒ¹æ ¼è¨ˆç®—å…¬å¼**: ç¸½é›¶å”®åƒ¹ - (ç¸½æ”¶å…¥åŸºæ•¸ Ã— æŠ˜æ‰£ç‡)
                        <br>
                        **é‹è²»è¦å‰‡**: ${document.getElementById('shipping-rule-display').textContent.replace('é‹è²»è¦å‰‡: ', '')}
                    </div>

                    <table>
                        <thead>
                            <tr>
                                <th>SKU</th>
                                <th>ç”¢å“åç¨±</th>
                                <th>æ•¸é‡</th>
                                <th>ç¸½ VP</th>
                                <th>é›¶å”®å–®åƒ¹</th>
                                <th>é›¶å”®ç¸½åƒ¹</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${orderItemsHtml}
                        </tbody>
                    </table>

                    <table class="summary-table" style="width: 40%; float: right;">
                        <tr>
                            <td style="text-align: right; width: 60%;">ç¸½éŠ·å”®é‡é»æ•¸ (VP):</td>
                            <td style="text-align: right; font-weight: bold; color: #009688;">${totalVP.toFixed(2)}</td>
                        </tr>
                        <tr>
                            <td style="text-align: right;">ç¸½é›¶å”®åƒ¹æ ¼ (æœªæŠ˜):</td>
                            <td style="text-align: right;">HK$ ${overallTotalRetail.toFixed(2)}</td>
                        </tr>
                        <tr>
                            <td style="text-align: right; color: #dc3545;">ç¸½æŠ˜æ‰£é‡‘é¡ (${discountPercentage}):</td>
                            <td style="text-align: right; color: #dc3545;">- HK$ ${totalDiscountAmount.toFixed(2)}</td>
                        </tr>
                        <tr>
                            <td style="text-align: right; border-top: 1px solid #000;">æ·¨ç”¢å“é‡‘é¡ (æœƒå“¡åƒ¹):</td>
                            <td style="text-align: right; border-top: 1px solid #000; font-weight: bold;">HK$ ${finalProductTotal.toFixed(2)}</td>
                        </tr>
                        <tr>
                            <td style="text-align: right;">é‹è²»:</td>
                            <td style="text-align: right;">HK$ ${appliedShippingFee.toFixed(2)}</td>
                        </tr>
                        <tr class="final-total">
                            <td style="text-align: right;">**å®¢æˆ¶æ‡‰ä»˜ç¸½é‡‘é¡ (å«é‹è²»):**</td>
                            <td style="text-align: right;">**HK$ ${totalAmountDue.toFixed(2)}**</td>
                        </tr>
                    </table>
                    <div style="clear: both;"></div>
                </body>
                </html>
            `;

            const printWindow = window.open('', '_blank');
            printWindow.document.write(printWindowContent);
            printWindow.document.close();
            printWindow.focus();
            // printWindow.print(); // å¯é¸ï¼šå¦‚æœæƒ³è‡ªå‹•å½ˆå‡ºåˆ—å°å°è©±æ¡†
        }
    </script>

</body>
</html>
